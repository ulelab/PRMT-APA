---
title: "hiererchical_clustering"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Add distal prox + find if gene lengthening or shortening

For each feature do dist vs proximal and then put feaure of gene as lengthening or shortening

```{r}
library(readr)
ds <- read_csv('../Outputs/All_categories_df.csv')
rownames(ds) <- ds$unique_featureID
```


```{r}
library(tidyr)
library(dplyr)
```

To add lengthening or shortening I need to decide on wich mean diff to use.
PRMT Reg cat: i used mean over timecourse
Reg: I looked at the siRNA picked the one with the biggest effect
Control: just control

I find which of the 3 siRNA causes the biggest effect and store that (instead of the mean)

```{r}
ds$RowMEAN <- 0
for (gene in unique(ds[ds$category=='Regulatable_sites',]$gene_ID)) {
   list <- as.vector(abs(ds[ds$gene_ID==gene,7:9]))
   l1 <- max(list[[1]],na.rm = T)
   l2 <- max(list[[2]],na.rm = T)
   l3 <- max(list[[3]],na.rm = T)
   ifelse((l1>l2 & l1>l3),
          ds[ds$gene_ID==gene,]$RowMEAN <- ds[ds$gene_ID==gene,]$mean_diffsiELAVL1,
          ifelse((l2>l1 & l2>l3),ds[ds$gene_ID==gene,]$RowMEAN <- ds[ds$gene_ID==gene,]$mean_diffsiSam68,
                 ds[ds$gene_ID==gene,]$RowMEAN <- ds[ds$gene_ID==gene,]$mean_diffsiCFIM25))
}
```

This one kinda useless but there are 7 genes with more than 2 features (as different ones where picked up for different siRNA ds) so I picked the 2 with biggest effect (after decided for which siRNA the effect was biggest)
```{r}
a <- ds  %>% group_by(gene_ID) %>% filter(category=='Regulatable_sites') %>% slice_max(RowMEAN)
b <- ds  %>% group_by(gene_ID) %>% filter(category=='Regulatable_sites') %>% slice_min(RowMEAN)

to_remove <- ds[ds$category=='Regulatable_sites',][!(ds[ds$category=='Regulatable_sites',]$unique_featureID %in% rbind(a,b)$unique_featureID),]$unique_featureID

ds <- ds[!(ds$unique_featureID %in% to_remove),]

ds[ds$category=='PRMT_regulated',]$RowMEAN <- rowMeans(ds[ds$category=='PRMT_regulated',10:14],na.rm = T)

#a <- ds[ds$category=='Regulatable_sites',c(1:14,85:89)]
```



Added column called location where inserted if PAS was proximal or distal

```{r}
ds$Location <- 'distal'
for (gene in ds$gene_ID) {
  if (nrow(ds[ds$gene_ID==gene,])>2) {
    ds[ds$gene_ID==gene,]$Location <- NA
  }else{
  
  ifelse ((ds[ds$gene_ID==gene,]$strand=='+') ,
    {if(ds[ds$gene_ID==gene,]$start[1] >ds[ds$gene_ID==gene,]$start[1] ) {
      ds[ds$gene_ID==gene,][2,]$Location <- 'proximal'
    }else{
      ds[ds$gene_ID==gene,][1,]$Location <- 'proximal'
      }},
    {if(ds[ds$gene_ID==gene,]$start[1] >ds[ds$gene_ID==gene,]$start[1] ) {
      ds[ds$gene_ID==gene,][1,]$Location <- 'proximal'
    }else{
      ds[ds$gene_ID==gene,][2,]$Location <- 'proximal'
    }} )}
  
}

table(complete.cases(ds$Location ))
```

Looked at sign of mean diff to pick if len or short
```{r}
ds <- ds %>% group_by(gene_ID) %>% mutate(Effect= 
                                      ifelse(category!='Control_sites'
                                             ,ifelse((Location=='distal' & RowMEAN>0)
                                               ,'lengthening',
                                               ifelse((Location=='proximal' & RowMEAN<0)
                                               ,'lengthening','shortening'
                                               )
                                               ),
                                               'Control')
                                             )


#a <- ds[,c(1:14,85:90)]

```


## let's see if I can add a dummy variable for Location and Shortening/lengthening

```{r}
ds <- ds %>% mutate(Location_dummy = ifelse(Location=='distal',1,0))
ds <- ds %>% mutate(Effect_dummy = ifelse(Effect=='shortening',1,
                                          ifelse(Effect=='lengthening',2,0)))

```

### shortening lenghtening summary


```{r}
table(ds$Effect,ds$category)
```

#Plot

```{r}
library(ggpubr)
library(factoextra)
```

```{r}
res.pca <- prcomp(ds[complete.cases(ds[,7:14]),c(7:14)],  scale = FALSE)
# Coordinates of individuals
ind.coord <- as.data.frame(get_pca_ind(res.pca)$coord)
# Add clusters obtained using the K-means algorithm
res <- cbind(ind.coord,ds[complete.cases(ds[,7:14]),])
variance.percent <- factoextra::get_eigenvalue(res.pca)[,2]
rownames(res) <- res$unique_featureID
```


```{r}
ggscatter(
  res, x = "Dim.1", y = "Dim.2", 
  color = "category", palette = "jco", ellipse = TRUE, ellipse.type = "convex",
  shape ='category', size = 1,  legend = "right", ggtheme = theme_bw(),
  xlab = paste0("Dim 1 (", round(variance.percent[1],2), "% )" ),
  ylab = paste0("Dim 2 (", round(variance.percent[2],2), "% )" )
) 
```
```{r}
ggscatter(
  res, x = "Dim.1", y = "Dim.2", 
  color = "Effect", palette = "jco", ellipse = TRUE, ellipse.type = "convex", size = 1,  legend = "right", ggtheme = theme_bw(),
  xlab = paste0("Dim 1 (", variance.percent[1], "% )" ),
  ylab = paste0("Dim 2 (", variance.percent[2], "% )" )
) 
```


#Hierarchical clustering 

Complete
(or furthest-neighbor): it is the maximal intercluster dissimilarity.
Compute all pairwise dissimilarities between the observations in cluster A and the observations in cluster B, and record the largest of these dissimilarities.

See both!
```{r}
library(stats)
library(readr)
library(dplyr)
library(dendextend)
```


```{r}
#ds <- read_csv('../Outputs/All_categories_df.csv')
rownames(ds) <- ds$unique_featureID

set.seed(1234)
```


first take the complete cases (no NA) of the mean diff columns
Add a column that assigns a color to the 3 categories

### normal

```{r}
ds.1 <- ds[complete.cases(ds[,7:14]),]

ds.1 <-ds.1 %>%  mutate( color = ifelse(category=='Control_sites','red' ,  ifelse(category=='Regulatable_sites','blue' , "yellow")))
```


IMPORTANT: convert df to matrix otherwise the rownames won't be kept and we need them to backtrace the color in the other matrix

```{r}
ds.1 <- as.matrix(ds.1[,c(7:14,1,87,93)])

rownames(ds.1) <-ds.1[,'unique_featureID']
```

Compute distance (without the columns with categorical data: unique feature, the category and the color assigned)
Then do clustering with hclust method complete should be best
```{r}
distSamples <- dist(ds.1[,-c(9,10,11)])
hc <- hclust(distSamples,method = 'complete')
hc
```

Convert to a dendogram object +
color branches based on the category
```{r}
dend <- as.dendrogram(hc)

dend2 <- color_branches(dend, col=ds.1[labels(dend),'color'])
```

function to remove labels as there are too many and won't be able to read them anyway

```{r}
noLabel <- function(x) {
  if (stats::is.leaf(x)) {
    attr(x, "label") <- NULL }
  return(x)
}

dend2 <- dendrapply(dend2, noLabel)
```


```{r}
plot(dend2,main='Clustering normal'  ) ;  rect.hclust(hc,k = 3); legend(x='topleft', legend=c("Control_sites", "Regulatable_sites",'PRMT_regulated'),
       col=c("red", "blue",'yellow'),lty=1, cex=0.8) 

```

```{r}
plot(dend2,horiz = T ,main='Clustering normal' ); legend(x='topleft', legend=c("Control_sites", "Regulatable_sites",'PRMT_regulated'),
       col=c("red", "blue",'yellow'),lty=1, cex=0.8)
```

### try to get out labels category and plot

```{r}
tree_labels.3 <- cutree(hc,3)
res$hc <- as.factor(tree_labels.3)
#a <- as.data.frame(tree_labels.3)$tree_labels.3
ggscatter(
  res, x = "Dim.1", y = "Dim.2", 
  color = "hc", fill='light gray',palette = "jco", ellipse = TRUE, ellipse.type = "convex",
  shape = 'hc', size = 1,  legend = "right", ggtheme = theme_bw(),
  xlab = paste0("Dim 1 (", round(variance.percent[1],2), "% )" ),
  ylab = paste0("Dim 2 (", round(variance.percent[2],2), "% )" )
) 
```



### Do hierarchical clustering separating shortening from lengthening


####lengthening

```{r}
ds.3 <- ds %>% filter(Effect!='shortening')
ds.3 <- ds.3[complete.cases(ds.3[,7:14]),]

ds.3 <-ds.3 %>%  mutate(color_categ = ifelse(category=='Control_sites','red' ,  ifelse(category=='Regulatable_sites','blue' , "yellow")))

ds.3 <- as.matrix(ds.3[,c(7:14,1,87,93)])

rownames(ds.3) <-ds.3[,'unique_featureID']
```

```{r}
distSamples <- dist(ds.3[,-c(9,10,11)])
hc <- hclust(distSamples,method = 'complete')
hc
```

```{r}
dend <- as.dendrogram(hc)

dend2 <- color_branches(dend, col=ds.3[labels(dend),'color_categ'])
```

```{r}
noLabel <- function(x) {
  if (stats::is.leaf(x)) {
    attr(x, "label") <- NULL }
  return(x)
}

dend2 <- dendrapply(dend2, noLabel)

```


```{r}
plot(dend2 ,main='Clustering lengthening' ) ;  rect.hclust(hc,k = 3); legend(x='topleft', legend=c("Control_sites", "Regulatable_sites",'PRMT_regulated'),
       col=c("red", "blue",'yellow'),lty=1, cex=0.8) 
```



####shortening

```{r}
ds.3 <- ds %>% filter(Effect!='lengthening')
ds.3 <- ds.3[complete.cases(ds.3[,7:14]),]

ds.3 <-ds.3 %>%  mutate(color_categ = ifelse(category=='Control_sites','red' ,  ifelse(category=='Regulatable_sites','blue' , "yellow")))

ds.3 <- as.matrix(ds.3[,c(7:14,1,87,93)])

rownames(ds.3) <-ds.3[,'unique_featureID']
```

```{r}
distSamples <- dist(ds.3[,-c(9,10,11)])
hc <- hclust(distSamples,method = 'complete')
hc
```

```{r}
dend <- as.dendrogram(hc)

dend2 <- color_branches(dend, col=ds.3[labels(dend),'color_categ'])
```

```{r}
noLabel <- function(x) {
  if (stats::is.leaf(x)) {
    attr(x, "label") <- NULL }
  return(x)
}

dend2 <- dendrapply(dend2, noLabel)

```


```{r}
plot(dend2, main='Clustering shortening' ) ;  rect.hclust(hc,k = 3); legend(x='topleft', legend=c("Control_sites", "Regulatable_sites",'PRMT_regulated'),
       col=c("red", "blue",'yellow'),lty=1, cex=0.8) 
```


####Try using dummy variable for hierarchical clustering


```{r}
ds.2 <- ds[complete.cases(ds[,7:14]),]

ds.2 <-ds.2 %>%  mutate(color_categ = ifelse(category=='Control_sites','red' ,  ifelse(category=='Regulatable_sites','blue' , "yellow")))

ds.2 <-ds.2 %>%  mutate(color_effect = ifelse(Effect=='lengthening','red' ,  ifelse(Effect=='shortening','blue' , "yellow")))

ds.2 <- ds.2 %>% mutate(Lengthening=ifelse(Effect=='lengthening',1,0))
ds.2 <- ds.2 %>% mutate(Control=ifelse(Effect=='Control',1,0))
ds.2 <- ds.2 %>% mutate(shortening=ifelse(Effect=='shortening',1,0))


ds.2 <- as.matrix(ds.2[,c(7:14,1,87,93,94,95,96,97)])

rownames(ds.2) <-ds.2[,'unique_featureID']
```

Compute distance (without the columns with categorical data: unique feature, the category and the color assigned)
Then do clustering with hclust method complete should be best
```{r}
distSamples <- dist(ds.2[,-c(9,10,10,11,12)])
hc <- hclust(distSamples,method = 'complete')
hc
```

```{r}
dend <- as.dendrogram(hc)

dend2 <- color_branches(dend, col=ds.2[labels(dend),'color_categ'])
dend2.2 <- color_branches(dend, col=ds.2[labels(dend),'color_effect'])

```

function to remove labels as there are too many and won't be able to read them anyway

```{r}
noLabel <- function(x) {
  if (stats::is.leaf(x)) {
    attr(x, "label") <- NULL }
  return(x)
}

dend2 <- dendrapply(dend2, noLabel)
dend2.2 <- dendrapply(dend2.2, noLabel)

```


```{r}
plot(dend2.2,,main='Dummy variable for effect, colored by effect' ) ;  rect.hclust(hc,k = 3); legend(x='topleft', legend=c("Lengthening", "Shortening",'Control'),
       col=c("red", "blue",'yellow'),lty=1, cex=0.8) 

```


```{r}
plot(dend2,main='Dummy variable for effect, colored by category' ) ;  rect.hclust(hc,k = 3); legend(x='topleft', legend=c("Control_sites", "Regulatable_sites",'PRMT_regulated'),
       col=c("red", "blue",'yellow'),lty=1, cex=0.8) 

```
#Complex Heatmaps 

libraries loading

```{r}
library(ComplexHeatmap)
library(RColorBrewer)
library(viridis)
library(circlize)
```

There are quite a lot of NAs (tried and doesnt cluster)
So unfortunately only kept complete cases
cat: mean differences 7:14, 87 category features belong 
```{r}
ds.1 <- ds[complete.cases(ds[,7:14]),c(7:14,87,89,90)]
```

```{r}
complete_cases <- ds[complete.cases(ds[,7:14]),7:14]
complete_cases <- as.matrix(complete_cases)
```

## Normal


```{r}
f1 = colorRamp2(seq(min(complete_cases), max(complete_cases), length = 3), c("red", "white", "dark blue"))

#rowAnnotation(foo2 = 18:1, bar2 = anno_barplot(runif(18)) 
Heatmap(complete_cases, name = "Complete cases heatmap",col=f1,row_km  = 3,
    column_title = " Mean difference values",right_annotation =rowAnnotation(category = ds.1$category, effect=ds.1$Effect,location=ds.1$Location))

```


## shorteing /lengthening



```{r}
ds_L <- ds %>% filter(Effect!='shortening')
ds_L <- ds_L[complete.cases(ds_L[,7:14]),]

ds.l <- as.matrix(ds_L[,c(7:14)])

f1 = colorRamp2(seq(-1,1, length = 3), c("red", "white", "dark blue"))

#rowAnnotation(foo2 = 18:1, bar2 = anno_barplot(runif(18)) 
Heatmap(ds.l, name = "Lengthening heatmap",col=f1,row_km  = 3,
    column_title = " Mean difference values",right_annotation =rowAnnotation(category = ds_L$category, effect=ds_L$Effect ))
```
```{r}
ds_S <- ds %>% filter(Effect!='lengthening')
ds_S <- ds_S[complete.cases(ds_S[,7:14]),]

ds.s <- as.matrix(ds_S[,c(7:14)])

f1 = colorRamp2(seq(-1,1, length = 3), c("red", "white", "dark blue"))

#rowAnnotation(foo2 = 18:1, bar2 = anno_barplot(runif(18)) 
Heatmap(ds.s, name = "Shortening heatmap",col=f1,row_km  = 3,
    column_title = " Mean difference values",right_annotation =rowAnnotation(category = ds_S$category, effect=ds_S$Effect ))
```

## distal proximal


```{r}
ds_dis<- ds %>% filter(Location=='distal')
ds_dis <- ds_dis[complete.cases(ds_dis[,7:14]),]

ds_dis.n <- as.matrix(ds_dis[,c(7:14)])

f1 = colorRamp2(seq(-1,1, length = 3), c("red", "white", "dark blue"))

#rowAnnotation(foo2 = 18:1, bar2 = anno_barplot(runif(18)) 
Heatmap(ds_dis.n, name = "Distal heatmap",col=f1,row_km  = 3,
    column_title = " Mean difference values",right_annotation =rowAnnotation(category = ds_dis$category, effect=ds_dis$Effect ))
```
```{r}
ds_pro<- ds %>% filter(Location=='proximal')
ds_pro <- ds_pro[complete.cases(ds_pro[,7:14]),]

ds_pro.n <- as.matrix(ds_pro[,c(7:14)])

f1 = colorRamp2(seq(-1,1, length = 3), c("red", "white", "dark blue"))

#rowAnnotation(foo2 = 18:1, bar2 = anno_barplot(runif(18)) 
Heatmap(ds_pro.n, name = "Proximal heatmap",col=f1,row_km  = 3,
    column_title = " Mean difference values",right_annotation =rowAnnotation(category = ds_pro$category, effect=ds_pro$Effect ))
```





## Dummy variable effect

```{r}
ds.D <- ds[complete.cases(ds[,7:14]),]

ds.D <- ds.D %>% mutate(Lengthening=ifelse(Effect=='lengthening',1,0))
ds.D <- ds.D %>% mutate(Control=ifelse(Effect=='Control',1,0))
ds.D <- ds.D %>% mutate(shortening=ifelse(Effect=='shortening',1,0))


ds.d <- as.matrix(ds.D[,c(7:14,93,94,95)])

f1 = colorRamp2(seq(-1,1, length = 3), c("red", "white", "dark blue"))

Heatmap(ds.d, name = "Dummy variable heatmap",col=f1,row_km  = 3,
    column_title = " Mean difference values",right_annotation =rowAnnotation(category = ds.D$category, effect=ds.D$Effect ),use_raster = FALSE)
```


