---
title: "hiererchical_clustering"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#data
```{r}
library(tidyr)
library(tidyverse)
ds <- read.csv('../Outputs/All_categories_DP_LS.csv')
```


## let's see if I can add a dummy variable for Location and Shortening/lengthening

```{r}
ds <- ds %>% mutate(Location_dummy = ifelse(Location=='distal',1,0))
ds <- ds %>% mutate(Effect_dummy = ifelse(Effect=='shortening',1,
                                          ifelse(Effect=='lengthening',2,0)))

```

### shortening lenghtening summary


```{r}
table(ds$Effect,ds$category)
```

#Plot

```{r}
library(ggpubr)
library(factoextra)
```

```{r}
res.pca <- prcomp(ds[complete.cases(ds[,7:14]),c(7:14)],  scale = FALSE)
# Coordinates of individuals
ind.coord <- as.data.frame(get_pca_ind(res.pca)$coord)
# Add clusters obtained using the K-means algorithm
res <- cbind(ind.coord,ds[complete.cases(ds[,7:14]),])
variance.percent <- factoextra::get_eigenvalue(res.pca)[,2]
rownames(res) <- res$unique_featureID
```


```{r}
ggscatter(
  res, x = "Dim.1", y = "Dim.2", 
  color = "category", palette = "jco", ellipse = TRUE, ellipse.type = "convex",
  shape ='category', size = 1,  legend = "right", ggtheme = theme_bw(),
  xlab = paste0("Dim 1 (", round(variance.percent[1],2), "% )" ),
  ylab = paste0("Dim 2 (", round(variance.percent[2],2), "% )" )
) 
```
```{r}
ggscatter(
  res, x = "Dim.1", y = "Dim.2", 
  color = "Effect", palette = "jco", ellipse = TRUE, ellipse.type = "convex", size = 1,  legend = "right", ggtheme = theme_bw(),
  xlab = paste0("Dim 1 (", variance.percent[1], "% )" ),
  ylab = paste0("Dim 2 (", variance.percent[2], "% )" )
) 
```


#Hierarchical clustering 

Complete
(or furthest-neighbor): it is the maximal intercluster dissimilarity.
Compute all pairwise dissimilarities between the observations in cluster A and the observations in cluster B, and record the largest of these dissimilarities.

See both!
```{r}
library(stats)
library(readr)
library(dplyr)
library(dendextend)
```


```{r}
set.seed(1234)
```


first take the complete cases (no NA) of the mean diff columns
Add a column that assigns a color to the 3 categories



####format data
```{r}
ds.1 <- ds[complete.cases(ds[,7:14]),c(7:14,1,87:89)]
table(ds.1$Effect,ds.1$category)
ds.1 <- ds.1 %>% mutate(Lengthening=ifelse(Effect=='lengthening',1,0))
ds.1 <- ds.1 %>% mutate(Control=ifelse(Effect=='Control',1,0))
ds.1 <- ds.1 %>% mutate(shortening=ifelse(Effect=='shortening',1,0))
ds.1 <- ds.1 %>% mutate(color_effect=ifelse(shortening==1,'pink',ifelse(Lengthening==1,'blue','green')))
ds.1 <-ds.1%>% mutate(distal=ifelse(Location=='distal',1,0))
ds.1 <- ds.1 %>% mutate(proximal=ifelse(Location=='proximal',1,0))

ds.1 <- ds.1 %>% mutate(color_effect=ifelse(Effect=='shortening','orange',ifelse(Effect=='lengthening','purple','green')))
ds.1 <- ds.1 %>% mutate(color_dist_prox=ifelse(Location=='distal','magenta','turquoise'))

ds.1 <-ds.1 %>%  mutate( color = ifelse(category=='Control_sites','red' ,  ifelse(category=='Regulatable_sites','blue' , "yellow")))
```

```{r}
table(ds.1$category,ds.1$Effect)/2
```


### normal
IMPORTANT: convert df to matrix otherwise the rownames won't be kept and we need them to backtrace the color in the other matrix

```{r}
ds.n <- as.matrix(ds.1)

rownames(ds.n) <-ds.n[,'unique_featureID']
```

Compute distance (without the columns with categorical data: unique feature, the category and the color assigned)
Then do clustering with hclust method complete should be best
```{r}
distSamples <- dist(ds.n[,c(1:8)])
hc <- hclust(distSamples,method = 'complete')
hc
```

Convert to a dendogram object +
color branches based on the category
```{r}
dend <- as.dendrogram(hc)

dend_cat <- color_branches(dend, col=ds.n[labels(dend),'color'])
dend_eff <- color_branches(dend, col=ds.n[labels(dend),'color_effect'])
dend_loc <- color_branches(dend, col=ds.n[labels(dend),'color_dist_prox'])

```

function to remove labels as there are too many and won't be able to read them anyway

```{r}
noLabel <- function(x) {
  if (stats::is.leaf(x)) {
    attr(x, "label") <- NULL }
  return(x)
}

dend_cat <- dendrapply(dend_cat, noLabel)
dend_eff <- dendrapply(dend_eff, noLabel)
dend_loc <- dendrapply(dend_loc, noLabel)

```


```{r}
plot(dend_cat,main='Clustering normal colored category'  ) ;  rect.hclust(hc,k = 3); legend(x='topleft', legend=c("Control_sites", "Regulatable_sites",'PRMT_regulated'),
       col=c("red", "blue",'yellow'),lty=1, cex=0.8) 

```

```{r}
plot(dend_cat,horiz = T ,main='Clustering normal' ); legend(x='topleft', legend=c("Control_sites", "Regulatable_sites",'PRMT_regulated'),
       col=c("red", "blue",'yellow'),lty=1, cex=0.8)
```


```{r}
plot(dend_eff,main='Clustering normal colored effect'  ) ;  rect.hclust(hc,k = 3); legend(x='topleft', legend=c("Control", "lengthening",'shortening'),
       col=c("green", "purple",'orange'),lty=1, cex=0.8) 

```

```{r}
plot(dend_loc,main='Clustering normal colored location'  ) ;  rect.hclust(hc,k = 3); legend(x='topleft', legend=c("distal", "proximal"),
       col=c("magenta", "turquoise"),lty=1, cex=0.8) 

```

##### try to get out labels category and plot

```{r}
tree_labels.3 <- cutree(hc,3)
res$hc <- as.factor(tree_labels.3)
#a <- as.data.frame(tree_labels.3)$tree_labels.3
ggscatter(
  res, x = "Dim.1", y = "Dim.2", 
  color = "hc", fill='light gray',palette = "jco", ellipse = TRUE, ellipse.type = "convex",
  shape = 'hc', size = 1,  legend = "right", ggtheme = theme_bw(),
  xlab = paste0("Dim 1 (", round(variance.percent[1],2), "% )" ),
  ylab = paste0("Dim 2 (", round(variance.percent[2],2), "% )" )
) 
```



##### Do hierarchical clustering separating shortening from lengthening


######lengthening

```{r}
ds.3 <- ds.1[ds.1[,12]!='shortening',]

rownames(ds.3) <-ds.3[,'unique_featureID']
```

```{r}
distSamples <- dist(ds.3[,c(1:8)])
hc <- hclust(distSamples,method = 'complete')
hc
```

```{r}
dend <- as.dendrogram(hc)

dend_cat <- color_branches(dend, col=ds.3[labels(dend),'color'])
dend_loc <- color_branches(dend, col=ds.3[labels(dend),'color_dist_prox'])
dend_eff <- color_branches(dend, col=ds.3[labels(dend),'color_effect'])

```

```{r}
dend_cat <- dendrapply(dend_cat, noLabel)
dend_loc <- dendrapply(dend_loc, noLabel)
dend_eff <- dendrapply(dend_eff, noLabel)
```


```{r}
plot(dend_cat ,main='Clustering lengthening colored category' ) ;  rect.hclust(hc,k = 3); legend(x='topleft', legend=c("Control_sites", "Regulatable_sites",'PRMT_regulated'),
       col=c("red", "blue",'yellow'),lty=1, cex=0.8) 

plot(dend_loc ,main='Clustering lengthening colored Location'  ) ;  rect.hclust(hc,k = 3); legend(x='topleft', legend=c("Distal", "Proximal"),
       col=c("magenta", "turquoise"),lty=1, cex=0.8) 

plot(dend_eff ,main='Clustering lengthening colored Effect' ) ;  rect.hclust(hc,k = 3); legend(x='topleft', legend=c("Control", "Lengthening"),
       col=c("green", "purple"),lty=1, cex=0.8) 

```



######shortening

```{r}
ds.3 <- ds.1[ds.1[,12]!='lengthening',]

rownames(ds.3) <-ds.3[,'unique_featureID']
```

```{r}
distSamples <- dist(ds.3[,-c(9:13)])
hc <- hclust(distSamples,method = 'complete')
hc
```

```{r}
dend <- as.dendrogram(hc)

dend_cat <- color_branches(dend, col=ds.3[labels(dend),'color'])
dend_loc <- color_branches(dend, col=ds.3[labels(dend),'color_dist_prox'])
dend_eff <- color_branches(dend, col=ds.3[labels(dend),'color_effect'])

```

```{r}
dend_cat <- dendrapply(dend_cat, noLabel)
dend_loc <- dendrapply(dend_loc, noLabel)
dend_eff <- dendrapply(dend_eff, noLabel)
```


```{r}
plot(dend_cat ,main='Clustering Shortening colored category' ) ;  rect.hclust(hc,k = 3); legend(x='topleft', legend=c("Control_sites", "Regulatable_sites",'PRMT_regulated'),
       col=c("red", "blue",'yellow'),lty=1, cex=0.8) 

plot(dend_loc ,main='Clustering Shortening colored Location'  ) ;  rect.hclust(hc,k = 3); legend(x='topleft', legend=c("Distal", "Proximal"),
       col=c("magenta", "turquoise"),lty=1, cex=0.8) 

plot(dend_eff ,main='Clustering Shortening colored Effect' ) ;  rect.hclust(hc,k = 3); legend(x='topleft', legend=c("Control", "Shortening"),
       col=c("green", "orange"),lty=1, cex=0.8) 

```

###Dummy variable for hierarchical clustering

##### Leng/short

```{r}
ds.3 <- as.matrix(ds.1)

rownames(ds.3) <-ds.3[,'unique_featureID']
```

Compute distance (without the columns with categorical data: unique feature, the category and the color assigned)
Then do clustering with hclust method complete should be best
```{r}
distSamples <- dist(ds.3[,c(1:8,13:15)])
hc <- hclust(distSamples,method = 'complete')
hc
```


```{r}
distSamples <- dist(ds.3[,c(1:8,13:15)])
hc <- hclust(distSamples,method = 'complete')
hc
```

```{r}
dend <- as.dendrogram(hc)

dend_cat <- color_branches(dend, col=ds.3[labels(dend),'color'])
dend_loc <- color_branches(dend, col=ds.3[labels(dend),'color_dist_prox'])
dend_eff <- color_branches(dend, col=ds.3[labels(dend),'color_effect'])

```

```{r}
dend_cat <- dendrapply(dend_cat, noLabel)
dend_loc <- dendrapply(dend_loc, noLabel)
dend_eff <- dendrapply(dend_eff, noLabel)
```


```{r}
plot(dend_cat ,main='Dummy variable Effect colored category' ) ;  rect.hclust(hc,k = 3); legend(x='topleft', legend=c("Control_sites", "Regulatable_sites",'PRMT_regulated'),
       col=c("red", "blue",'yellow'),lty=1, cex=0.8) 

plot(dend_loc ,main='Dummy variable Effect colored Location'  ) ;  rect.hclust(hc,k = 3); legend(x='topleft', legend=c("Distal", "Proximal"),
       col=c("magenta", "turquoise"),lty=1, cex=0.8) 

plot(dend_eff ,main='Dummy variable Effect colored Effect' ) ;  rect.hclust(hc,k = 3); legend(x='topleft', legend=c("Control", "Lengthening",'Shortening'),
       col=c("green", "purple",'orange'),lty=1, cex=0.8) 

```




##### Dist/prox


```{r}
ds.3 <- as.matrix(ds.1)

rownames(ds.3) <-ds.3[,'unique_featureID']
```


```{r}
distSamples <- dist(ds.3[,c(1:8,17:18)])
hc <- hclust(distSamples,method = 'complete')
hc
```

```{r}
dend <- as.dendrogram(hc)

dend_cat <- color_branches(dend, col=ds.3[labels(dend),'color'])
dend_loc <- color_branches(dend, col=ds.3[labels(dend),'color_dist_prox'])
dend_eff <- color_branches(dend, col=ds.3[labels(dend),'color_effect'])

```

```{r}
dend_cat <- dendrapply(dend_cat, noLabel)
dend_loc <- dendrapply(dend_loc, noLabel)
dend_eff <- dendrapply(dend_eff, noLabel)
```


```{r}
plot(dend_cat ,main='Dummy variable Location colored category' ) ;  rect.hclust(hc,k = 3); legend(x='topleft', legend=c("Control_sites", "Regulatable_sites",'PRMT_regulated'),
       col=c("red", "blue",'yellow'),lty=1, cex=0.8) 

plot(dend_loc ,main='Dummy variable Location  colored Location'  ) ;  rect.hclust(hc,k = 3); legend(x='topleft', legend=c("Distal", "Proximal"),
       col=c("magenta", "turquoise"),lty=1, cex=0.8) 

plot(dend_eff ,main='Dummy variable Location colored Effect' ) ;  rect.hclust(hc,k = 3); legend(x='topleft', legend=c("Control", "Shortening",'Lengthening'),
       col=c("green", "orange",'purple'),lty=1, cex=0.8) 

```


#Complex Heatmaps 

libraries loading

```{r}
library(ComplexHeatmap)
library(RColorBrewer)
library(viridis)
library(circlize)
```

There are quite a lot of NAs (tried and doesnt cluster)
So unfortunately only kept complete cases
cat: mean differences 7:14, 87 category features belong 

```{r}
ds.3 <- as.matrix(ds.1[,1:8],rownames.force = F)
```

## Normal


```{r}
f1 = colorRamp2(seq(-1,1, length = 3), c("red", "white", "dark blue"))

Heatmap(ds.3, name = "Complete cases heatmap",col=f1,row_km  = 3,
    column_title = " Mean difference values",right_annotation =rowAnnotation(category = ds.1$category, effect=ds.1$Effect,location=ds.1$Location))

```


## shorteing /lengthening



```{r}
ds.3 <- ds.1 %>% filter(Effect!='shortening')

ds.l <- as.matrix(ds.3[,c(1:8)],rownames.force = F)

f1 = colorRamp2(seq(-1,1, length = 3), c("red", "white", "dark blue"))

Heatmap(ds.l, name = "Lengthening heatmap",col=f1,row_km  = 3,
    column_title = " Mean difference values",right_annotation =rowAnnotation(category = ds.3$category, effect=ds.3$Effect ,location=ds.3$Location))
```

```{r}
ds.3 <- ds.1 %>% filter(Effect!='lengthening')
ds_S <- ds.3[,1:8]

ds_S <- as.matrix(ds_S[,c(1:8)],rownames.force = F)

f1 = colorRamp2(seq(-1,1, length = 3), c("red", "white", "dark blue"))

Heatmap(ds_S, name = "Shortening heatmap",col=f1,row_km  = 3,
    column_title = " Mean difference values",right_annotation =rowAnnotation(category = ds.3$category, effect=ds.3$Effect,location=ds.3$Location ))
```

## distal proximal


```{r}
ds.3<- ds.1 %>% filter(Location=='distal')
ds_dis <-  as.matrix(ds.3[,1:8],rownames.force = F)

f1 = colorRamp2(seq(-1,1, length = 3), c("red", "white", "dark blue"))

Heatmap(ds_dis, name = "Distal heatmap",col=f1,row_km  = 3,
    column_title = " Mean difference values",right_annotation =rowAnnotation(category = ds.3$category, effect=ds.3$Effect ,location=ds.3$Location))
```

```{r}
ds.3<- ds.1 %>% filter(Location=='proximal')
ds_pro <-  as.matrix(ds.3[,1:8],rownames.force = F)

f1 = colorRamp2(seq(-1,1, length = 3), c("red", "white", "dark blue"))

Heatmap(ds_pro, name = "Proximal heatmap",col=f1,row_km  = 3,
    column_title = " Mean difference values",right_annotation =rowAnnotation(category = ds.3$category, effect=ds.3$Effect ,location=ds.3$Location))
```





## Dummy variable effect

```{r}
ds_de <-  as.matrix(ds.1[,c(1:8,13:15)],rownames.force = F)

f1 = colorRamp2(seq(-1,1, length = 3), c("red", "white", "dark blue"))

Heatmap(ds_de, name = "Dummy variable effect heatmap",col=f1,row_km  = 3,
    column_title = " Mean difference values",right_annotation =rowAnnotation(category = ds.1$category, effect=ds.1$Effect ,location=ds.1$Location),use_raster = F)
```

## Dummy variable Location

```{r}
ds_dl <-  as.matrix(ds.1[,c(1:8,17:18)],rownames.force = F)

f1 = colorRamp2(seq(-1,1, length = 3), c("red", "white", "dark blue"))

Heatmap(ds_dl, name = "Dummy variable location heatmap",col=f1,row_km  = 3,
    column_title = " Mean difference values",right_annotation =rowAnnotation(category = ds.1$category, effect=ds.1$Effect ,location=ds.1$Location))
```

