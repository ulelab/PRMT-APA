---
title: "1"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(ggplot2)
library("vioplot")
knitr::opts_chunk$set(echo = TRUE)
```


# FX:

Function that returns for each PAS if distal/proximal

```{r}
distal_proximal <- function(data_frame){
  data_frame$PAS <- 'proximal'
  for (gene in unique(data_frame$gene_id)) {
    ifelse( unique(data_frame[data_frame$gene_id==gene,]$strand)=='+', {
      max <- max(data_frame[data_frame$gene_id==gene,]$start)
      feature <- as.vector(data_frame[data_frame$gene_id==gene & data_frame$start == max,]$feature_id)
      data_frame[data_frame$gene_id==gene & data_frame$feature_id %in% feature,]$PAS <- 'distal'
    },{
      min <- min(data_frame[data_frame$gene_id==gene,]$start)
      feature <- as.vector(data_frame[data_frame$gene_id==gene & data_frame$start == min,]$feature_id)
      data_frame[data_frame$gene_id==gene & data_frame$feature_id %in% feature,]$PAS <- 'distal'
    })
    
  }
  return(data_frame)
}
```

Adds a column called 'unique_featureID':  a unique feature ID for each PAS based on gene, chr, start position and PAS sequence motif
```{r}
unique_featureID <- function(dataset){
  dataset <- dataset %>%  mutate(unique_featureID=paste(
  dataset$V8,
  unlist(strsplit(dataset$feature_id, split='_'))[seq(2,nrow(dataset)*3,3)],
                                 dataset$chr,'start',dataset$start,
                                 sep='_'))
  
  return(dataset)
}

```

For all the genes that have 2 or more PAS takes min and max difference (one <0 and one >0) and returns a vector of features that pass this.
In this way exludes genes with single PAS, reduces the ones with 2 or more to 2 with opposite effect otherwise not kept
```{r}
take_min_max <- function(dataset){
  to_keep <- vector()
  #for each gene 
  #look at how many unique features
 
  for (gene in unique(dataset$gene_id)) {
    uniqueFG <- unique(dataset[dataset$gene_id==gene,]$unique_featureID)
    #if more than 2 features 
    if (length(uniqueFG)>=2) {
      lowest <- 0
      biggest <- 0
      f_ID_biggest <- character()
      f_ID_smallest <- character()
      #look at mean diff values of each feature and take smallest (mandatory less than 0)
      #look at mean diff values of each feature and take biggest (mandatory bigger than 0)
      #so we have opposite
      for (feature in uniqueFG) {
        mean_tmp <- mean(dataset[dataset$gene_id==gene & dataset$unique_featureID==feature,]$mean_diff)
      
        if (mean_tmp<lowest) {
          lowest <- mean_tmp 
          f_ID_smallest <- feature}
        if (mean_tmp>biggest) {
          biggest <- mean_tmp 
          f_ID_biggest <- feature}
        }
      if (lowest!=0 & biggest!=0 ) {
        to_keep <- append(to_keep, c(f_ID_smallest,f_ID_biggest))
      }
      
    }
    
}
return(to_keep)
}
```



sv_DIF70_siRNA: returns slicing vector of PAS that have a change that passes siRNA filtering
siRNA filtering: given a SiRNA datasets checks that the mean diff after kd is less than 70% of mean diff of DI at 72h

dataset_1:the one you take as reference
dataset_2:the one you check if its value is within 70%


```{r}
sv_DIF70_siRNA <- function(dataset_1,dataset_2){
  slicing_vector <- vector()
  
  #per ogni feature nel datset usa solo 72h
  for (feature in dataset_1$unique_featureID) {
    #Se la feature è presente nel dataset siRNA
    if(feature %in% dataset_2$unique_featureID) {
      #get mean diff
      mean_dif <- abs(dataset_1[dataset_1$unique_featureID==feature,]$mean_diff)
      #get value 70%
      vector_70 <- 0.7*mean_dif
      #get mean diff of siRNA ds (or other ds)
      mean_diff_2 <- abs(dataset_2[dataset_2$unique_featureID==feature,]$mean_diff)
      if (is.na(mean_diff_2)!=TRUE) {
        if(mean_diff_2<vector_70){
          slicing_vector <- append(slicing_vector, feature)
        
      }
      
    }
  }}
  return(slicing_vector)
}
```

vector_keep_genes_PO: keeps pairs only checks if genes have 2 unique features
(used ONLY after sv_DIF70_siRNA has been applied if for example PAS had ulterior filtering and due to this some genes lost 1 of the 2 features)

```{r}
vector_keep_genes_PO <- function(dataset){
  keep_2 <- vector()
  for (genes in unique(dataset$gene_id)) {
      len <- length(unique(dataset[dataset$gene_id==genes,]$unique_featureID))
      if (len==2) {
          keep_2 <- append(keep_2,genes)
        }
  }
  return(keep_2)
}
```

# Single + Double inhibition of ADMA (PRMT1) and SMDA(PRMT5)

'../Data/DrimSeq/single_vs_double_96hrs_drimseq_tables'

## Read Data + Rename

###Read single + double past

```{r}
ADMA_96h <- read.csv('../Data/DrimSeq/single_vs_double_96hrs_drimseq_tables/ADMAi_96hrs_with_mean_diff_coords.csv')
SDMA_96h <- read.csv('../Data/DrimSeq/single_vs_double_96hrs_drimseq_tables/SDMAi_96hrs_with_mean_diff_coords.csv')
ADMA_SDMA_96h <- read.csv('../Data/DrimSeq/single_vs_double_96hrs_drimseq_tables/SDMAi+ADMAi_96hr_with_mean_diff_coords.csv')
```

Rename:Change columns name of values so no time and then add anoher one based on time

```{r}
ADMA_96h <- unique_featureID(ADMA_96h)
SDMA_96h <- unique_featureID(SDMA_96h)
```

Rename columns so that when merging all have the same name :)
```{r}
ADMA_SDMA_96h <-ADMA_SDMA_96h  %>% 
  rename(ctrl_1=DMSO_96hrs_1,
         ctrl_2=DMSO_96hrs_2,
         ctrl_3=DMSO_96hrs_3,
         condition_1=SDMAi_ADMAi_96hrs_1,
         condition_2=SDMAi_ADMAi_96hrs_2,
         condition_3=SDMAi_ADMAi_96hrs_3
         )

ADMA_SDMA_96h$sample <- '96hrs_prev'
ADMA_SDMA_96h <- unique_featureID(ADMA_SDMA_96h)
```




### Read Double Inhibition All timepoints

'../Data/DrimSeq/SDMAi+ADMAi_timecourse_drimseq_tables/two_step_24hrs_with_mean_diff_coords.csv'

Basically same as for batch 1 

Read

```{r}
SDMA_ADMA_24h<- read.csv('../Data/DrimSeq/SDMAi+ADMAi_timecourse_drimseq_tables/two_step_24hrs_with_mean_diff_coords.csv')
SDMA_ADMA_48h <- read.csv('../Data/DrimSeq/SDMAi+ADMAi_timecourse_drimseq_tables/two_step_48hrs_with_mean_diff_coords.csv')
SDMA_ADMA_72h <- read.csv('../Data/DrimSeq/SDMAi+ADMAi_timecourse_drimseq_tables/two_step_72hrs_with_mean_diff_coords.csv')
SDMA_ADMA_96h <- read.csv('../Data/DrimSeq/SDMAi+ADMAi_timecourse_drimseq_tables/two_step_96hrs_with_mean_diff_coords.csv')
```

Rename

```{r, echo=FALSE}
SDMA_ADMA_24h <-SDMA_ADMA_24h  %>% 
  rename(ctrl_1=DMSO_24hrs_1,
         ctrl_2=DMSO_24hrs_2,
         ctrl_3=DMSO_24hrs_3,
         condition_1=SDMAi_ADMAi_24hrs_1,
         condition_2=SDMAi_ADMAi_24hrs_2,
         condition_3=SDMAi_ADMAi_24hrs_3
         )

SDMA_ADMA_24h$sample <- '24'

SDMA_ADMA_24h <- unique_featureID(SDMA_ADMA_24h)

SDMA_ADMA_48h <-SDMA_ADMA_48h  %>% 
  rename(ctrl_1=DMSO_48hrs_1,
         ctrl_2=DMSO_48hrs_2,
         ctrl_3=DMSO_48hrs_3,
         condition_1=SDMAi_ADMAi_48hrs_1,
         condition_2=SDMAi_ADMAi_48hrs_2,
         condition_3=SDMAi_ADMAi_48hrs_3
         )

SDMA_ADMA_48h$sample <- '48'

SDMA_ADMA_48h <- unique_featureID(SDMA_ADMA_48h)


SDMA_ADMA_72h <-SDMA_ADMA_72h  %>% 
  rename(ctrl_1=DMSO_72hrs_1,
         ctrl_2=DMSO_72hrs_2,
         ctrl_3=DMSO_72hrs_3,
         condition_1=SDMAi_ADMAi_72hrs_1,
         condition_2=SDMAi_ADMAi_72hrs_2,
         condition_3=SDMAi_ADMAi_72hrs_3
         )

SDMA_ADMA_72h$sample <- '72'
SDMA_ADMA_72h <- unique_featureID(SDMA_ADMA_72h)

SDMA_ADMA_96h <-SDMA_ADMA_96h  %>% 
  rename(ctrl_1=DMSO_96hrs_1,
         ctrl_2=DMSO_96hrs_2,
         ctrl_3=DMSO_96hrs_3,
         condition_1=SDMAi_ADMAi_96hrs_1,
         condition_2=SDMAi_ADMAi_96hrs_2,
         condition_3=SDMAi_ADMAi_96hrs_3
         )

SDMA_ADMA_96h$sample <- '96'
SDMA_ADMA_96h <- unique_featureID(SDMA_ADMA_96h)

```

Merged dataset (+save) of DI with names and columns formatted
```{r}
merged_unfiltered_formatted <- rbind(SDMA_ADMA_24h,SDMA_ADMA_48h,SDMA_ADMA_72h,ADMA_SDMA_96h,SDMA_ADMA_96h)
length(unique(merged_unfiltered_formatted$unique_featureID))
length(unique(merged_unfiltered_formatted$gene_id))

write_csv(merged_unfiltered_formatted,'../Data/Outputs/merged_unfiltered_formatted')
```

Also write individual files formatted just in case I need them 

```{r}
write_csv(SDMA_ADMA_24h,'../Data/Outputs/SDMA_ADMA_24h_formatted.csv')
write_csv(SDMA_ADMA_48h,'../Data/Outputs/SDMA_ADMA_48h_formatted.csv')
write_csv(SDMA_ADMA_72h,'../Data/Outputs/SDMA_ADMA_72h_formatted.csv')
write_csv(SDMA_ADMA_96h,'../Data/Outputs/SDMA_ADMA_96h_formatted.csv')
```

checking that most PAS are found in all of the samples (pre filtered) 
Some diff between 96 past and 96 timepoint (should be similar as bio rep)
whereas across timepoints not big diff in n of features identified
```{r}
table(SDMA_ADMA_96h$unique_featureID %in% ADMA_SDMA_96h$unique_featureID)
table(SDMA_ADMA_96h$unique_featureID %in% SDMA_ADMA_48h$unique_featureID)
table(SDMA_ADMA_24h$unique_featureID %in% SDMA_ADMA_48h$unique_featureID)
table(SDMA_ADMA_72h$unique_featureID %in% SDMA_ADMA_48h$unique_featureID)
```

### Plot delta usage for each timepoint - overall (Not that usefull anymore so not gonna run it) 



```{r, eval=FALSE, echo=FALSE}
ADMA_SDMA_96h <- distal_proximal(ADMA_SDMA_96h)
SDMA_ADMA_24h <- distal_proximal(SDMA_ADMA_24h)
SDMA_ADMA_48h <- distal_proximal(SDMA_ADMA_48h)
SDMA_ADMA_72h <- distal_proximal(SDMA_ADMA_72h)
SDMA_ADMA_96h <- distal_proximal(SDMA_ADMA_96h)
```

```{r, eval=FALSE, echo=FALSE}
merged <- rbind(ADMA_SDMA_96h,SDMA_ADMA_24h,SDMA_ADMA_48h,SDMA_ADMA_72h,SDMA_ADMA_96h)

merged1 <- merged %>% 
  filter(mean_diff>0.1 | mean_diff< -0.1)

ggplot(merged1, aes(y =mean_diff , x = PAS,color=PAS),group_by=PAS) +
  geom_violin(alpha = 0.5) +
  theme(legend.position = "none")+
  theme_bw()+
  ylim(c(-1,1))+
  facet_wrap(vars(factor(timepoint_h)))
  
```

#PRMT regulated sites

##Filtering 


Filtering features in each ds
```{r}
sign_96h_past <- filter(ADMA_SDMA_96h,((mean_diff>0.2 | mean_diff< -0.2) & twostep_transcript_padj<0.05))$unique_featureID
sign_96h <- filter(SDMA_ADMA_96h,((mean_diff>0.2 | mean_diff< -0.2) & twostep_transcript_padj<0.05))$unique_featureID
sign_24h <- filter(SDMA_ADMA_24h,((mean_diff>0.2 | mean_diff< -0.2) & twostep_transcript_padj<0.05))$unique_featureID
sign_48h <- filter(SDMA_ADMA_48h,((mean_diff>0.2 | mean_diff< -0.2) & twostep_transcript_padj<0.05))$unique_featureID
sign_72h <- filter(SDMA_ADMA_72h,((mean_diff>0.2 | mean_diff< -0.2) & twostep_transcript_padj<0.05))$unique_featureID
```

merging features so present in at least 1 DS:

```{r}
tot_sign <- unique(c(sign_96h_past,sign_24h,sign_48h,sign_72h,sign_96h))
```

Merge features (across DS)  significant it at least one DS 
```{r}
merged_ds <- rbind(ADMA_SDMA_96h[ADMA_SDMA_96h$unique_featureID %in% tot_sign,],
                   SDMA_ADMA_24h[SDMA_ADMA_24h$unique_featureID %in% tot_sign,],
                   SDMA_ADMA_48h[SDMA_ADMA_48h$unique_featureID %in% tot_sign,],
                   SDMA_ADMA_72h[SDMA_ADMA_72h$unique_featureID %in% tot_sign,],
                   SDMA_ADMA_96h[SDMA_ADMA_96h$unique_featureID %in% tot_sign,]
                   )


```


Check feature is used >10% (so >0.1 and <-0.1) in all datasets and consistent so all>0 or all <0
```{r}
#Create a vector of features to remove
slicing_remove_2 <- vector()
#for each feature
for (feature in unique(merged_ds$unique_featureID)) {
  #get n of rows feature is present i.e n of samples it is present (max 5)
  n_r <- nrow(merged_ds[merged_ds$unique_featureID==feature,])
  remove <- FALSE
  #if less than 5 we don't want it 
  if (n_r<5) {
    remove <- TRUE
  }else{
    #check if NA (mostly happens in 96 past) and if there are we don't want to keep it
    if(TRUE %in% is.na(merged_ds[merged_ds$unique_featureID==feature,]$mean_diff))
           {remove <-TRUE 
    }else{ 
      #get sign of first one
      sign_n <- sign(merged_ds[merged_ds$unique_featureID==feature,]$mean_diff[1])
      #for each dataset (i 1:5)
      #check if mean diff is not >10% (value>-0.1 & value< 0.1) or if even tho bigger than 10% it's diff sign
      for (i in (1:5)) {
          value <- merged_ds[merged_ds$unique_featureID==feature,]$mean_diff[i]
          if ((value>-0.1 & value< 0.1) | sign_n!=sign(value) )
          {remove <- TRUE} 
          }
        }
      }
  
  if (remove==TRUE) {
    slicing_remove_2 <- append(slicing_remove_2,feature)
  }
}

#table(!(merged_ds$unique_featureID %in% slicing_remove_2))
filtered <- merged_ds[!(merged_ds$unique_featureID %in% slicing_remove_2),]

#just me checking if numbers are correct
length(unique(filtered$unique_featureID)) *5 #should be equal to n of rows of df
length(unique(filtered$gene_id))
```



Remove all genes/feature that don't have to opposite features (if more 2 takes most significant ones)

```{r}
filtered_2 <- filtered[filtered$unique_featureID %in% take_min_max(filtered),]
length(unique(filtered_2$gene_id)) #should be /5 nrows of df
length(unique(filtered_2$unique_featureID))
```

Write 2 files_
filtered=Filtered20_10_across.csv: all PAS that are significant and change>20% + >10% in all datasets 
filtered_2=Filtered_20_10_2xgene.csv: filtering of filter so that Pairs Only
```{r}
write_csv(filtered,'../Data/Outputs/Filtered20_10_across.csv')
write_csv(filtered_2,'../Data/Outputs/Filtered_PO.csv')
```

From here on I made a copy of filtered_2 called Filtered_PO and of filtered as Filtered20_10_across  was just usefull in case I messed up and I still need to change names (same name as written files gonna change that sooner or later)
```{r}
#Filtered_PO<-read.csv('../Data/Outputs/Filtered_PO.csv')
#Filtered20_10_across<-read.csv('../Data/Outputs/Filtered20_10_across.csv')

#Filtered_PO <- Filtered_PO %>% rename(sample = 'timepoint_h')

#Filtered20_10_across <- Filtered20_10_across %>% rename(sample = 'timepoint_h')

Filtered_PO<- filtered_2
Filtered20_10_across <- filtered
```

##SiRNA integration

Read and formatted siRNAs datasets
```{r}
siCFIM25_DMSO<-read.csv('../Data/DrimSeq/SDMAi_ADMAi_+_siRNAs_drimseq_tables/siCtrl_DMSO_vs_siCFIM25_DMSO_with_mean_diff_coords.csv')
siELAVL1_DMSO <- read.csv('../Data/DrimSeq/SDMAi_ADMAi_+_siRNAs_drimseq_tables/siCtrl_DMSO_vs_siELAVL1_DMSO_with_mean_diff_coords.csv')
siSam68_DMSO <- read.csv('../Data/DrimSeq/SDMAi_ADMAi_+_siRNAs_drimseq_tables/sictrl_DMSO_vs_siSam68_DMSO_with_mean_diff_coords.csv')

```


```{r}
siCFIM25_DMSO$sample <- 'siCFIM25'
siCFIM25_DMSO <- unique_featureID(siCFIM25_DMSO)


siELAVL1_DMSO$sample <- 'siELAVL1'
siELAVL1_DMSO <- unique_featureID(siELAVL1_DMSO)

siSam68_DMSO$sample <- 'siSam68'
siSam68_DMSO <- unique_featureID(siSam68_DMSO)
```

Check to see if change in siRNAs is less than 70%

For sites to be defined as PRMT-regulated the effect of the siRNA conditions can't exceed 70% of the PRMT-triggered effect

Do on absolute value as we don't want opposite effect as well (DI 0.2, CFIM25 -0.3)

Features to keep for each siRNAs dataset:

-- I kept them separate now and merged them later :)

```{r}
#use 72h as it's incubation time used for siRNAs datsets
#gives vector of those that pass
Vector_sv_CFIM25 <- sv_DIF70_siRNA(Filtered_PO[Filtered_PO$sample=='72',],siCFIM25_DMSO)
Vector_sv_siELAVL1 <- sv_DIF70_siRNA(Filtered_PO[Filtered_PO$sample=='72',],siELAVL1_DMSO)
Vector_sv_siSam68 <- sv_DIF70_siRNA(Filtered_PO[Filtered_PO$sample=='72',],siSam68_DMSO)
```

Intersection as they need to be less than 70 in all siRNAs datasets
```{r}
features_keep <- Reduce(intersect,list(Vector_sv_CFIM25,Vector_sv_siELAVL1,Vector_sv_siSam68))
```


we are going to loose the 'pairing' as it's done on features and sometimes one of the 2 might not be present in siRNA dataset: need to restore
```{r}
Filtered_siRNAs <- Filtered_PO[Filtered_PO$unique_featureID %in% features_keep,]
length(unique(Filtered_siRNAs$gene_id))
length(unique(Filtered_siRNAs$unique_featureID))
```

```{r}
Filtered_siRNAs_vector <- vector_keep_genes_PO(Filtered_siRNAs)
Filtered_PO_siRNAs <- Filtered_siRNAs[Filtered_siRNAs$gene_id %in% Filtered_siRNAs_vector,]
length(unique(Filtered_PO_siRNAs$gene_id)) 
length(unique(Filtered_PO_siRNAs$unique_featureID)) 

write_csv(Filtered_PO_siRNAs,'../Data/Outputs/PRMT_regulated')
```

# siRNA regulatable 

Changed column names as I am going to merge them later :) (I already added the sample they come from should have also renamed earlier I will do it sooner or later)

```{r}
siCFIM25_DMSO <-siCFIM25_DMSO  %>% 
  rename(ctrl_1='ctrl_DMSO_1',
         ctrl_2='ctrl_DMSO_2',
         ctrl_3='ctrl_DMSO_3',
         condition_1='CFIM25_DMSO_1',
         condition_2='CFIM25_DMSO_2',
         condition_3='CFIM25_DMSO_3',
         )

siSam68_DMSO <-siSam68_DMSO  %>% 
  rename(ctrl_1='ctrl_DMSO_1',
         ctrl_2='ctrl_DMSO_2',
         ctrl_3='ctrl_DMSO_3',
         condition_1='Sam68_DMSO_1',
         condition_2='Sam68_DMSO_2',
         condition_3='Sam68_DMSO_3',
         )

siELAVL1_DMSO <-siELAVL1_DMSO  %>% 
  rename(ctrl_1='ctrl_DMSO_1',
         ctrl_2='ctrl_DMSO_2',
         ctrl_3='ctrl_DMSO_3',
         condition_1='ELAVL1_DMSO_1',
         condition_2='ELAVL1_DMSO_2',
         condition_3='ELAVL1_DMSO_3',
         )
```


Filter to be >20 and significant

```{r}
length(siCFIM25_DMSO$unique_featureID)
length(unique(siCFIM25_DMSO$gene_id))

length(siSam68_DMSO$unique_featureID)
length(unique(siSam68_DMSO$gene_id))

length(siELAVL1_DMSO$unique_featureID)
length(unique(siELAVL1_DMSO$gene_id))
```


```{r}
siCFIM25_DMSO_20 <- siCFIM25_DMSO %>% 
  filter( (mean_diff>0.2 | mean_diff < -0.2) & twostep_transcript_padj<0.05 )

length(siCFIM25_DMSO_20$unique_featureID)
length(unique(siCFIM25_DMSO_20$gene_id))

siSam68_DMSO_20 <- siSam68_DMSO %>% 
  filter( (mean_diff>0.2 | mean_diff < -0.2) & twostep_transcript_padj<0.05 )

length(siSam68_DMSO_20$unique_featureID)
length(unique(siSam68_DMSO_20$gene_id))

siELAVL1_DMSO_20 <- siELAVL1_DMSO%>% 
  filter( (mean_diff>0.2 | mean_diff < -0.2) & twostep_transcript_padj<0.05 )

length(siELAVL1_DMSO_20$unique_featureID)
length(unique(siELAVL1_DMSO_20$gene_id))

#siSam68_DMSO_20[(!siSam68_DMSO_20$unique_featureID %in% Filtered_PO$unique_featureID),]

```

Control to avoid 70% similarity

```{r}
Vector_sv_CFIM25_2 <- sv_DIF70_siRNA(siCFIM25_DMSO_20,Filtered_PO[Filtered_PO$sample=='72',])
Vector_sv_EVAL1_2 <- sv_DIF70_siRNA(siELAVL1_DMSO_20,Filtered_PO[Filtered_PO$sample=='72',])
Vector_sv_Sam68_2 <- sv_DIF70_siRNA(siSam68_DMSO_20,Filtered_PO[Filtered_PO$sample=='72',])
```

Filter only non co-reg with DI If
feature not in DI dataset is discarded 

```{r}
siCFIM25_DMSO_20_70 <- siCFIM25_DMSO_20[siCFIM25_DMSO_20$unique_featureID %in% Vector_sv_CFIM25_2,]

length(siCFIM25_DMSO_20_70$unique_featureID)
length(unique(siCFIM25_DMSO_20_70$gene_id))

siEVAL1_DMSO_20_70 <- siELAVL1_DMSO_20[siELAVL1_DMSO_20$unique_featureID %in% Vector_sv_EVAL1_2,]

length(siEVAL1_DMSO_20_70$unique_featureID)
length(unique(siEVAL1_DMSO_20_70$gene_id))

siSam68_DMSO_20_70 <- siSam68_DMSO_20[siSam68_DMSO_20$unique_featureID %in% Vector_sv_Sam68_2,]

length(siSam68_DMSO_20_70$unique_featureID)
length(unique(siSam68_DMSO_20_70$gene_id))
```





Keep PO
```{r}
siCFIM25_DMSO_20_70_PO <- siCFIM25_DMSO_20_70[siCFIM25_DMSO_20_70$unique_featureID %in% take_min_max(siCFIM25_DMSO_20_70),]
siEVAL1_DMSO_20_70_PO <- siEVAL1_DMSO_20_70[siEVAL1_DMSO_20_70$unique_featureID %in% take_min_max(siEVAL1_DMSO_20_70),]
siSam68_DMSO_20_70_PO <- siSam68_DMSO_20_70[siSam68_DMSO_20_70$unique_featureID %in% take_min_max(siSam68_DMSO_20_70),] #empty!!

length(siCFIM25_DMSO_20_70_PO$unique_featureID)
length(unique(siCFIM25_DMSO_20_70_PO$gene_id))

length(siEVAL1_DMSO_20_70_PO$unique_featureID)
length(unique(siEVAL1_DMSO_20_70_PO$gene_id))

#siSam68_DMSO_20_70_PO no observations left :(((
```

siRNAs regulated sites
```{r}
merged_siRNA <- rbind(siCFIM25_DMSO_20_70_PO,siEVAL1_DMSO_20_70_PO,siSam68_DMSO_20_70_PO)

length(unique(merged_siRNA$gene_id))#76/2-> 38,of which  37 in siCFIM2 and 1 in siEVAL1_DMSO
length(unique(merged_siRNA$unique_featureID))


write_csv(merged_siRNA,'../Data/Outputs/siRNAs_regulated_sites')
```

#Co regulated sites:

```{r}
sv_DIF70_siRNA_more70 <- function(dataset_1,dataset_2){
  slicing_vector <- vector()
  
  #per ogni feature nel datset ADSMI_SDMI usa solo 72h
  for (feature in dataset_1$unique_featureID) {
    #Se la feature è presente nel dataset siRNA
    if(feature %in% dataset_2$unique_featureID) {
      #get mean diff
      mean_dif <- abs(dataset_1[dataset_1$unique_featureID==feature,]$mean_diff)
      #get value less than 70%
      #vector_70 <- mean_dif-0.7*mean_dif
      vector_70 <- 0.7*mean_dif
      #get mean diff of siRNA ds
      mean_diff_2 <- abs(dataset_2[dataset_2$unique_featureID==feature,]$mean_diff)
      if (is.na(mean_diff_2)!=TRUE) {
        if(mean_diff_2>=vector_70){
          slicing_vector <- append(slicing_vector, feature)

      }
      
    }
  }}
  return(slicing_vector)
}

```



```{r}
merged_20_sir <- rbind(siELAVL1_DMSO_20,siCFIM25_DMSO_20,siSam68_DMSO_20)

to_keep_siELAVL1_DMSO_20 <- sv_DIF70_siRNA_more70( siELAVL1_DMSO_20,Filtered_PO[Filtered_PO$sample=='72',])
to_keep_siCFIM25_DMSO_20 <- sv_DIF70_siRNA_more70( siCFIM25_DMSO_20,Filtered_PO[Filtered_PO$sample=='72',])
to_keep_siSam68_DMSO_20 <- sv_DIF70_siRNA_more70( siSam68_DMSO_20,Filtered_PO[Filtered_PO$sample=='72',])

more70_siRNA <- unique(c(to_keep_siELAVL1_DMSO_20,to_keep_siCFIM25_DMSO_20,to_keep_siSam68_DMSO_20))
length(more70_siRNA)
```



```{r}
to_keep_siELAVL1_DMSO_20_DI <- sv_DIF70_siRNA_more70( Filtered_PO[Filtered_PO$sample=='72',],siELAVL1_DMSO_20)
to_keep_siCFIM25_DMSO_20_DI <- sv_DIF70_siRNA_more70( Filtered_PO[Filtered_PO$sample=='72',],siCFIM25_DMSO_20)
to_keep_siSam68_DMSO_20_DI <- sv_DIF70_siRNA_more70( Filtered_PO[Filtered_PO$sample=='72',],siSam68_DMSO_20)

more70_DI <- unique(c(to_keep_siELAVL1_DMSO_20_DI,to_keep_siCFIM25_DMSO_20_DI,to_keep_siSam68_DMSO_20_DI))
length(unique(more70_DI))
```




```{r}
union_70_both <-unique( c(more70_siRNA,more70_DI))

Merged_all_70 <- rbind(Filtered_PO,
                  merged_20_sir) %>% filter(unique_featureID %in% union_70_both )

length(unique(Merged_all_70$gene_id))
length(unique(Merged_all_70$unique_featureID))
```

```{r}

Merged_all_70_no_siRNA <- Merged_all_70[!(Merged_all_70$unique_featureID %in% merged_siRNA$unique_featureID),]
Merged_all_70_no_siRNA_noPRMT <- Merged_all_70_no_siRNA[!(Merged_all_70_no_siRNA$unique_featureID %in% Filtered_PO_siRNAs$unique_featureID),]

length(unique(Merged_all_70_no_siRNA_noPRMT$unique_featureID))
length(unique(Merged_all_70_no_siRNA_noPRMT$gene_id))
```

```{r}

v <- vector()
for (gene in unique(Merged_all_70_no_siRNA_noPRMT$gene_id)) {
  number <- nrow(Merged_all_70_no_siRNA_noPRMT[Merged_all_70_no_siRNA_noPRMT$gene_id==gene,])
  if (number>=12) {
    v <- append(v,gene)
  }
}
Merged_all_70_PO <- Merged_all_70_no_siRNA_noPRMT[Merged_all_70_no_siRNA_noPRMT$gene_id %in% v,]


length(unique(Merged_all_70_PO$gene_id))
length(unique(Merged_all_70_PO$unique_featureID))
```


```{r}
write_csv(Merged_all_70_PO,'../Data/Outputs/Co_regulated.csv')
```


#Control sites 
```{r}
merged_unfiltered_formatted_DI <- read_csv('../Data/Outputs/merged_unfiltered_formatted')

merged_unfiltered_siRNA <- rbind(siCFIM25_DMSO,siELAVL1_DMSO,siELAVL1_DMSO)

merged_unfiltered_all <- rbind(merged_unfiltered_formatted_DI,
                               merged_unfiltered_siRNA)

length(unique(merged_unfiltered_all$gene_id))
length(unique(merged_unfiltered_all$unique_featureID))

```


```{r}
keep_change_DMSO_10<- vector()
#for each feature
for (feature in unique(merged_unfiltered_all$unique_featureID)) {
  #get n of rows feature is present i.e n of samples it is present (max 8)
  n_r <- nrow(merged_unfiltered_all[merged_unfiltered_all$unique_featureID==feature,])
  remove <- FALSE
  #if less than 5 we don't want it 
  if (n_r<8) {
    remove <- TRUE
  }else{
    #check if NA (mostly happens in 96 past) and if there are we don't want to keep it
    if(TRUE %in% is.na(merged_unfiltered_all[merged_unfiltered_all$unique_featureID==feature,]$mean_diff))
           {remove <-TRUE 
    }else{ 
      #get sign of first one
      #for each dataset (i 1:5)
      #check if mean diff is not >10% (value>-0.1 & value< 0.1) or if even tho bigger than 10% it's diff sign
      for (i in (1:8)) {
          value <- merged_unfiltered_all[merged_unfiltered_all$unique_featureID==feature,]$mean_diff[i]
          DMSO <- merged_unfiltered_all[merged_unfiltered_all$unique_featureID==feature,]$ctrl_1[i]
          if (value < -0.1 | value > 0.1 |  DMSO<0.1 )
          {remove <- TRUE} 
          }
        }
      }
  
  if (remove==FALSE) {
    keep_change_DMSO_10 <- append(keep_change_DMSO_10,feature)
  }
}

merged_control_sites <- merged_unfiltered_all[merged_unfiltered_all$unique_featureID %in% keep_change_DMSO_10,]
merged_control_sites_PO <- merged_control_sites[merged_control_sites$gene_id %in% vector_keep_genes_PO(merged_control_sites),]
write_csv(merged_control_sites_PO,'../Data/Outputs/Control_sites')

length(unique(merged_control_sites$gene_id))
length(unique(merged_control_sites$unique_featureID))

length(unique(merged_control_sites_PO$gene_id))
length(unique(merged_control_sites_PO$unique_featureID))
```

#Control that no intersection

```{r}
#see if anything common
table(unique(Filtered_PO_siRNAs$gene_id) %in%  unique(merged_siRNA$gene_id) )
table(unique(Filtered_PO_siRNAs$gene_id) %in%  unique(Merged_all_70_PO$gene_id) )
table(unique(Filtered_PO_siRNAs$gene_id) %in%  unique(merged_control_sites_PO$gene_id) )

table(unique(merged_siRNA$gene_id) %in%  unique(Filtered_PO_siRNAs$gene_id) )
table(unique(merged_siRNA$gene_id) %in%  unique(Merged_all_70_PO$gene_id) )
table(unique(merged_siRNA$gene_id) %in%  unique(merged_control_sites_PO$gene_id) )


table(unique(Merged_all_70_PO$gene_id) %in%  unique(Filtered_PO_siRNAs$gene_id) )
table(unique(Merged_all_70_PO$gene_id) %in%  unique(merged_control_sites_PO$gene_id) )
table(unique(Merged_all_70_PO$gene_id) %in%  unique(merged_siRNA$gene_id) )

table(unique(merged_control_sites_PO$gene_id) %in%  unique(Filtered_PO_siRNAs$gene_id) )
table(unique(merged_control_sites_PO$gene_id) %in%  unique(merged_siRNA$gene_id) )
table(unique(merged_control_sites_PO$gene_id) %in%  unique(Merged_all_70_PO$gene_id) )
```

#Select data for hierarchical clustering

```{r}

ALL_data_categories <- rbind(
  merged_control_sites_PO,
  Merged_all_70_PO,
  Filtered_PO_siRNAs,
  merged_siRNA
)

write_csv(ALL_data_categories,'../Data/Outputs/All_categories_data')
```





