---
title: "1"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(ggplot2)
library("vioplot")
knitr::opts_chunk$set(echo = TRUE)
```


# FX:


Adds a column called 'unique_featureID':  a unique feature ID for each PAS based on gene, chr, start position and PAS sequence motif
```{r}
unique_featureID <- function(dataset){
  dataset <- dataset %>%  mutate(unique_featureID=paste(
  dataset$V8,
  unlist(strsplit(dataset$feature_id, split='_'))[seq(2,nrow(dataset)*3,3)],
                                 dataset$chr,'start',dataset$start,'end',dataset$end,
                                 sep='_'))
  
  return(dataset)
}

```



# Read Data


```{r}
ADMA_SDMA_96h <- read.csv('../BATCH_A_single_vs_double_96hrs_drimseq_tables/SDMAi+ADMAi_96hr_with_mean_diff_coords.csv')
```

Rename:Change columns name of values so no time and then add another one based on time


Rename columns so that when merging all have the same name :)
```{r}
ADMA_SDMA_96h <-ADMA_SDMA_96h  %>% 
  rename(ctrl_1=DMSO_96hrs_1,
         ctrl_2=DMSO_96hrs_2,
         ctrl_3=DMSO_96hrs_3,
         condition_1=SDMAi_ADMAi_96hrs_1,
         condition_2=SDMAi_ADMAi_96hrs_2,
         condition_3=SDMAi_ADMAi_96hrs_3
         )

ADMA_SDMA_96h$sample <- '96hrs_prev'
ADMA_SDMA_96h <- unique_featureID(ADMA_SDMA_96h)

SDMA_ADMA_24h<- read.csv('../BATCH_B_SDMAi+ADMAi_timecourse_drimseq_tables/two_step_24hrs_with_mean_diff_coords.csv')
SDMA_ADMA_48h <- read.csv('../BATCH_B_SDMAi+ADMAi_timecourse_drimseq_tables/two_step_48hrs_with_mean_diff_coords.csv')
SDMA_ADMA_72h <- read.csv('../BATCH_B_SDMAi+ADMAi_timecourse_drimseq_tables/two_step_72hrs_with_mean_diff_coords.csv')
SDMA_ADMA_96h <- read.csv('../BATCH_B_SDMAi+ADMAi_timecourse_drimseq_tables/two_step_96hrs_with_mean_diff_coords.csv')

SDMA_ADMA_24h <-SDMA_ADMA_24h  %>% 
  rename(ctrl_1=DMSO_24hrs_1,
         ctrl_2=DMSO_24hrs_2,
         ctrl_3=DMSO_24hrs_3,
         condition_1=SDMAi_ADMAi_24hrs_1,
         condition_2=SDMAi_ADMAi_24hrs_2,
         condition_3=SDMAi_ADMAi_24hrs_3
         )

SDMA_ADMA_24h$sample <- '24'

SDMA_ADMA_24h <- unique_featureID(SDMA_ADMA_24h)

SDMA_ADMA_48h <-SDMA_ADMA_48h  %>% 
  rename(ctrl_1=DMSO_48hrs_1,
         ctrl_2=DMSO_48hrs_2,
         ctrl_3=DMSO_48hrs_3,
         condition_1=SDMAi_ADMAi_48hrs_1,
         condition_2=SDMAi_ADMAi_48hrs_2,
         condition_3=SDMAi_ADMAi_48hrs_3
         )

SDMA_ADMA_48h$sample <- '48'

SDMA_ADMA_48h <- unique_featureID(SDMA_ADMA_48h)


SDMA_ADMA_72h <-SDMA_ADMA_72h  %>% 
  rename(ctrl_1=DMSO_72hrs_1,
         ctrl_2=DMSO_72hrs_2,
         ctrl_3=DMSO_72hrs_3,
         condition_1=SDMAi_ADMAi_72hrs_1,
         condition_2=SDMAi_ADMAi_72hrs_2,
         condition_3=SDMAi_ADMAi_72hrs_3
         )

SDMA_ADMA_72h$sample <- '72'
SDMA_ADMA_72h <- unique_featureID(SDMA_ADMA_72h)

SDMA_ADMA_96h <-SDMA_ADMA_96h  %>% 
  rename(ctrl_1=DMSO_96hrs_1,
         ctrl_2=DMSO_96hrs_2,
         ctrl_3=DMSO_96hrs_3,
         condition_1=SDMAi_ADMAi_96hrs_1,
         condition_2=SDMAi_ADMAi_96hrs_2,
         condition_3=SDMAi_ADMAi_96hrs_3
         )

SDMA_ADMA_96h$sample <- '96'
SDMA_ADMA_96h <- unique_featureID(SDMA_ADMA_96h)


siCFIM25_DMSO<-read.csv('../BATCH_C_SDMAi_ADMAi_+_siRNAs_drimseq_tables/siCtrl_DMSO_vs_siCFIM25_DMSO_with_mean_diff_coords.csv')
siELAVL1_DMSO <- read.csv('../BATCH_C_SDMAi_ADMAi_+_siRNAs_drimseq_tables/siCtrl_DMSO_vs_siELAVL1_DMSO_with_mean_diff_coords.csv')
siSam68_DMSO <- read.csv('../BATCH_C_SDMAi_ADMAi_+_siRNAs_drimseq_tables/sictrl_DMSO_vs_siSam68_DMSO_with_mean_diff_coords.csv')

siCFIM25_DMSO$sample <- 'siCFIM25'
siCFIM25_DMSO <- unique_featureID(siCFIM25_DMSO)


siELAVL1_DMSO$sample <- 'siELAVL1'
siELAVL1_DMSO <- unique_featureID(siELAVL1_DMSO)

siSam68_DMSO$sample <- 'siSam68'
siSam68_DMSO <- unique_featureID(siSam68_DMSO)

siCFIM25_DMSO <-siCFIM25_DMSO  %>% 
  rename(ctrl_1='ctrl_DMSO_1',
         ctrl_2='ctrl_DMSO_2',
         ctrl_3='ctrl_DMSO_3',
         condition_1='CFIM25_DMSO_1',
         condition_2='CFIM25_DMSO_2',
         condition_3='CFIM25_DMSO_3',
         )

siSam68_DMSO <-siSam68_DMSO  %>% 
  rename(ctrl_1='ctrl_DMSO_1',
         ctrl_2='ctrl_DMSO_2',
         ctrl_3='ctrl_DMSO_3',
         condition_1='Sam68_DMSO_1',
         condition_2='Sam68_DMSO_2',
         condition_3='Sam68_DMSO_3',
         )

siELAVL1_DMSO <-siELAVL1_DMSO  %>% 
  rename(ctrl_1='ctrl_DMSO_1',
         ctrl_2='ctrl_DMSO_2',
         ctrl_3='ctrl_DMSO_3',
         condition_1='ELAVL1_DMSO_1',
         condition_2='ELAVL1_DMSO_2',
         condition_3='ELAVL1_DMSO_3',
         )
```

# Merge Huge DF


```{r}
merged_unfiltered_all <- rbind(siELAVL1_DMSO,siSam68_DMSO,siCFIM25_DMSO,SDMA_ADMA_96h,SDMA_ADMA_72h,SDMA_ADMA_48h,SDMA_ADMA_24h,ADMA_SDMA_96h)
length(unique(merged_unfiltered_all$gene_id))
length(unique(merged_unfiltered_all$unique_featureID))

```



```{r}
#This takes a long time :))
library(zeallot)


#df_all <- data.frame(row.names=unique(merged_unfiltered_all$unique_featureID))
df_all.1 <- data.frame(row.names=unique(merged_unfiltered_all$unique_featureID))#[8001:length(unique(merged_unfiltered_all$unique_featureID))])#4001,8001
#df_all.2 <- data.frame(row.names=unique(merged_unfiltered_all$unique_featureID)[8000:length(unique(merged_unfiltered_all$unique_featureID))])

df_all <- df_all.1
for (feature in rownames(df_all) ){
  
  names <- merged_unfiltered_all[merged_unfiltered_all$unique_featureID==feature,]$sample
  df_all[rownames(df_all)==feature,'unique_featureID'] <- unique(merged_unfiltered_all[merged_unfiltered_all$unique_featureID==feature,]$unique_featureID)
  df_all[rownames(df_all)==feature,'gene_ID'] <- unique(merged_unfiltered_all[merged_unfiltered_all$unique_featureID==feature,]$gene_id)
  df_all[rownames(df_all)==feature,'chr'] <- unique(merged_unfiltered_all[merged_unfiltered_all$unique_featureID==feature,]$chr)
  df_all[rownames(df_all)==feature,'start'] <- unique(merged_unfiltered_all[merged_unfiltered_all$unique_featureID==feature,]$start)
  df_all[rownames(df_all)==feature,'end'] <- unique(merged_unfiltered_all[merged_unfiltered_all$unique_featureID==feature,]$end)
  df_all[rownames(df_all)==feature,'strand'] <- unique(merged_unfiltered_all[merged_unfiltered_all$unique_featureID==feature,]$strand)
  
  df_all[rownames(df_all)==feature,paste0('mean_diff',names)] %<-% merged_unfiltered_all[merged_unfiltered_all$unique_featureID==feature,]$mean_diff
  df_all[rownames(df_all)==feature,paste0('ctrl_',names)] %<-% merged_unfiltered_all[merged_unfiltered_all$unique_featureID==feature,]$ctrl_1
  df_all[rownames(df_all)==feature,paste0('condition_',names)] %<-% merged_unfiltered_all[merged_unfiltered_all$unique_featureID==feature,]$condition_1
  df_all[rownames(df_all)==feature,paste0('V5_',names)] %<-% merged_unfiltered_all[merged_unfiltered_all$unique_featureID==feature,]$V5
  df_all[rownames(df_all)==feature,paste0('twostep_gene_padj_',names)] %<-%   merged_unfiltered_all[merged_unfiltered_all$unique_featureID==feature,]$twostep_gene_padj
  df_all[rownames(df_all)==feature,paste0('twostep_transcript_padj_',names)] %<-% merged_unfiltered_all[merged_unfiltered_all$unique_featureID==feature,]$twostep_transcript_padj
  df_all[rownames(df_all)==feature,paste0('lr_',names)] %<-% merged_unfiltered_all[merged_unfiltered_all$unique_featureID==feature,]$lr
  df_all[rownames(df_all)==feature,paste0('df_',names)] %<-% merged_unfiltered_all[merged_unfiltered_all$unique_featureID==feature,]$df
  df_all[rownames(df_all)==feature,paste0('pvalue_',names)] %<-% merged_unfiltered_all[merged_unfiltered_all$unique_featureID==feature,]$pvalue
  df_all[rownames(df_all)==feature,paste0('adj_pvalue_',names)] %<-% merged_unfiltered_all[merged_unfiltered_all$unique_featureID==feature,]$adj_pvalue

}


df_all_1 <-df_all 


#write_csv(df_all,'../Outputs/Unfiltered_Formatted_All_Data_Sets_Final.csv')

```

```{r}
#I saved the df and I just read the output
df_all <- read_csv('../Outputs/Unfiltered_Formatted_All_Data_Sets_Final.csv')

```

```{r}
rownames(df_all) <- df_all$unique_featureID
length(unique(df_all$gene_ID))
```




#PRMT regulated

#20 at least 1 and 15 at least 1

For each dataset, filter feature that has 20% + <0.05 and then check if in one other dataset (hence or = |) see 15% change
Then filter the ds based on the feature that pass that for one of the datasets

```{r}
cutoff_1 <- 0.2
cutoff_2 <- 0.15

df_prmt_20_15_24 <- df_all%>% filter((
  ((mean_diff24>cutoff_1 | mean_diff24< -cutoff_1)
  & twostep_transcript_padj_24<0.05) &
  ( (mean_diff48>cutoff_2 | mean_diff48< -cutoff_2) |              
  (mean_diff72>cutoff_2 | mean_diff72< -cutoff_2) | 
  (mean_diff96>cutoff_2 | mean_diff96< -cutoff_2) |
  (mean_diff96hrs_prev>cutoff_2 | mean_diff96hrs_prev< -cutoff_2)) ))

df_prmt_20_15_48 <- df_all %>% filter((
  ((mean_diff48>cutoff_1 | mean_diff48< -cutoff_1)
  & twostep_transcript_padj_48<0.05) &
  ( (mean_diff24>cutoff_2 | mean_diff24< -cutoff_2) |              
  (mean_diff72>cutoff_2 | mean_diff72< -cutoff_2) | 
  (mean_diff96>cutoff_2 | mean_diff96< -cutoff_2) |
  (mean_diff96hrs_prev>cutoff_2 | mean_diff96hrs_prev< -cutoff_2)) ))


df_prmt_20_15_72 <- df_all%>% filter((
  ((mean_diff72>cutoff_1 | mean_diff72< -cutoff_1)
  & twostep_transcript_padj_72<0.05) &
  ( (mean_diff48>cutoff_2 | mean_diff48< -cutoff_2) |              
  (mean_diff24>cutoff_2 | mean_diff24< -cutoff_2) | 
  (mean_diff96>cutoff_2 | mean_diff96< -cutoff_2) |
  (mean_diff96hrs_prev>cutoff_2 | mean_diff96hrs_prev< -cutoff_2)) ))



df_prmt_20_15_96 <- df_all%>% filter((
  ((mean_diff96>cutoff_1 | mean_diff96< -cutoff_1)
  & twostep_transcript_padj_96<0.05) &
  ( (mean_diff48>cutoff_2 | mean_diff48< -cutoff_2) |              
  (mean_diff72>cutoff_2 | mean_diff72< -cutoff_2) | 
  (mean_diff24>cutoff_2 | mean_diff24< -cutoff_2) |
  (mean_diff96hrs_prev>cutoff_2 | mean_diff96hrs_prev< -cutoff_2)) ))



df_prmt_20_15_96_prev <- df_all%>% filter((
  ((mean_diff96hrs_prev>cutoff_1 | mean_diff96hrs_prev< -cutoff_1)
  & twostep_transcript_padj_96hrs_prev<0.05) &
  ( (mean_diff48>cutoff_2 | mean_diff48< -cutoff_2) |              
  (mean_diff72>cutoff_2 | mean_diff72< -cutoff_2) | 
  (mean_diff96>cutoff_2 | mean_diff96< -cutoff_2) |
  (mean_diff24>cutoff_2 | mean_diff24< -cutoff_2)) ))



df_prmt_20_15_v <- rbind(df_prmt_20_15_24,df_prmt_20_15_48,df_prmt_20_15_72,df_prmt_20_15_96,df_prmt_20_15_96_prev)$unique_featureID
df_prmt_20_15 <- df_all[df_all$unique_featureID %in%df_prmt_20_15_v, ]

nrow(df_prmt_20_15)
length(unique(df_prmt_20_15$gene_ID))
```



## 70% similarity

check 70% similarity, use abs so we avoid PRMT=0.3, siRNA= -0.3 problems
Used only 72hrs dataset as siRNA data was retrieved at that time so makes sense to compare just the 2
If feature not present in siRNA ds is discarded as we dont know the value :)

```{r}
df_prmt_20_15_70 <- df_prmt_20_15 %>% 
  filter((is.na(df_prmt_20_15$mean_diffsiCFIM25)!=TRUE)| (is.na(df_prmt_20_15$mean_diffsiELAVL1)!=TRUE)| (is.na(df_prmt_20_15$mean_diffsiSam68)!=TRUE))%>% 
  filter((
  (abs(mean_diff72) > 0.7*abs(mean_diffsiCFIM25) )& 
  (abs(mean_diff72) >0.7*abs(mean_diffsiELAVL1)) &  
  (abs(mean_diff72) >0.7*abs(mean_diffsiSam68) )))

```

##Keep only paired genes with opposite effect

Take the best feature (in terms of mean), independetly if it's positive or negative change. Then checkall other features of the gene and take the biggest effect one in the opposite direction

_Take the  mean of mean_diff across time points, then by gene take the maximum change in either direction (hence abs)and if same take value take 1 of the 2 (n=1)
```{r}
df_prmt_20_15_70$mean_diff_across <- rowMeans(df_prmt_20_15_70[,10:14],na.rm = T)
df_prmt_20_15_70.1 <- df_prmt_20_15_70 %>% group_by(gene_ID) %>% slice_max(abs(mean_diff_across),n=1,with_ties=FALSE)
```

_In the original ds I filter out all the features we found earlier + kept only corresponding genes 
computed the mean as before
```{r}
all_other_features <- df_all[!(df_all$unique_featureID %in% df_prmt_20_15_70.1$unique_featureID) & (df_all$gene_ID %in% df_prmt_20_15_70.1$gene_ID), ]

all_other_features$mean_diff_across <- rowMeans(all_other_features[,10:14],na.rm = T)
```

_went through all genes of the signifcant best feature ds +
checked if mean change was positive or negative
_if positive: we want to find a negative changing feature, so of all the features of that gene we keep the one with the smallest mean value 
_if negative: we want to find a positive changing feature, so of all the features of that gene we keep the one with the biggest mean value 
```{r}
features_to_add <- vector()
for (gene in df_prmt_20_15_70.1$gene_ID) {
  if (df_prmt_20_15_70.1[df_prmt_20_15_70.1$gene_ID==gene,]$mean_diff_across>0) {
      feature <- all_other_features[all_other_features$gene_ID==gene,] %>% slice_min(mean_diff_across<0,n=1,with_ties=FALSE)
     features_to_add<- append(features_to_add,feature$unique_featureID)} else {
      feature <- all_other_features[all_other_features$gene_ID==gene,] %>% slice_max(mean_diff_across>0,n=1,with_ties=FALSE)
     features_to_add<- append(features_to_add,feature$unique_featureID)}

  }
```

Then I simply merge the 2 df
```{r}
df_prmt_20_15_70_PO <- rbind(df_prmt_20_15_70.1,all_other_features[all_other_features$unique_featureID %in% features_to_add,])

write_csv(df_prmt_20_15_70_PO,'../Outputs/PRMT_reg.csv')
```




#Regulatable


##20 %

First filter feat that have 20% change + significance in at least 1 ds (hence or |)
```{r}
cut_off_1.reg <- 0.2
cut_off_2.reg <- 0.05

df_siRNA <- df_all 
df_siRNA_20 <- df_siRNA %>% filter(
  ((mean_diffsiCFIM25>cut_off_1.reg | mean_diffsiCFIM25< -cut_off_1.reg) & twostep_transcript_padj_siCFIM25<cut_off_2.reg)|
  ((mean_diffsiELAVL1>cut_off_1.reg | mean_diffsiELAVL1< -cut_off_1.reg) & twostep_transcript_padj_siELAVL1<cut_off_2.reg)|       
  ((mean_diffsiSam68>cut_off_1.reg | mean_diffsiSam68< -cut_off_1.reg) & twostep_transcript_padj_siSam68<cut_off_2.reg) 
)
```

## 70%

check for 70% similarity, again use abs to avoid opposite change problems.
Again checked only in 72hrs ds for same reason
If feature not present in PRMT 72hrs ds is discarded as we don't know the value :)

```{r}
df_siRNA_20_75 <- df_siRNA_20 %>%
  filter(is.na(df_siRNA_20$mean_diff72)!=TRUE) %>% 
  filter( 
  (abs(mean_diffsiCFIM25) > 0.7*abs(mean_diff72) )| 
  (abs(mean_diffsiELAVL1) >0.7*abs(mean_diff72)) | 
  (abs(mean_diffsiSam68) >0.7*abs(mean_diff72) ))
  

nrow(df_siRNA_20_75)
length(unique(df_siRNA_20_75$gene_ID))
```


##PO


```{r}
df_siRNA_20.CF <- df_siRNA_20 %>% filter((mean_diffsiCFIM25>0.2 | mean_diffsiCFIM25< -0.2) & twostep_transcript_padj_siCFIM25<0.05) %>% group_by(gene_ID) %>% slice_max(abs(mean_diffsiCFIM25),n=1,with_ties=FALSE)

df_siRNA_20.CF_other <- df_all[!(df_all$unique_featureID %in% df_siRNA_20.CF$unique_featureID) & (df_all$gene_ID %in% df_siRNA_20.CF$gene_ID),]

features_to_add <- vector()
for (gene in df_siRNA_20.CF$gene_ID) {
  if (df_siRNA_20.CF[df_siRNA_20.CF$gene_ID==gene,]$mean_diffsiCFIM25>0) {
      feature <- df_siRNA_20.CF_other[df_siRNA_20.CF_other$gene_ID==gene,] %>% slice_min(mean_diffsiCFIM25<0,n=1,with_ties=FALSE)
     features_to_add<- append(features_to_add,feature$unique_featureID)} else {
      feature <- df_siRNA_20.CF_other[df_siRNA_20.CF_other$gene_ID==gene,] %>% slice_max(mean_diffsiCFIM25>0,n=1,with_ties=FALSE)
     features_to_add<- append(features_to_add,feature$unique_featureID)}}

df_siRNA_20.CF_PO <- rbind(df_siRNA_20.CF,df_siRNA_20.CF_other[df_siRNA_20.CF_other$unique_featureID %in% features_to_add,])
```

```{r}
df_siRNA_20.EL <- df_siRNA_20 %>% filter((mean_diffsiELAVL1>0.2 | mean_diffsiELAVL1< -0.2) & twostep_transcript_padj_siELAVL1<0.05) %>% group_by(gene_ID) %>% slice_max(abs(mean_diffsiELAVL1),n=1,with_ties=FALSE)

df_siRNA_20.EL_other <- df_all[!(df_all$unique_featureID %in% df_siRNA_20.EL$unique_featureID) & (df_all$gene_ID %in% df_siRNA_20.EL$gene_ID),]

features_to_add <- vector()
for (gene in df_siRNA_20.EL$gene_ID) {
  if (df_siRNA_20.EL[df_siRNA_20.EL$gene_ID==gene,]$mean_diffsiELAVL1>0) {
      feature <- df_siRNA_20.EL_other[df_siRNA_20.EL_other$gene_ID==gene,] %>% slice_min(mean_diffsiELAVL1<0,n=1,with_ties=FALSE)
     features_to_add<- append(features_to_add,feature$unique_featureID)} else {
      feature <- df_siRNA_20.EL_other[df_siRNA_20.EL_other$gene_ID==gene,] %>% slice_max(mean_diffsiELAVL1>0,n=1,with_ties=FALSE)
     features_to_add<- append(features_to_add,feature$unique_featureID)}}

df_siRNA_20.EL_PO <- rbind(df_siRNA_20.EL,df_siRNA_20.EL_other[df_siRNA_20.EL_other$unique_featureID %in% features_to_add,])


```

```{r}
df_siRNA_20.SM <- df_siRNA_20 %>% filter((mean_diffsiSam68>0.2 | mean_diffsiSam68< -0.2) & twostep_transcript_padj_siSam68<0.05) %>% group_by(gene_ID) %>% slice_max(abs(mean_diffsiSam68),n=1,with_ties=FALSE)

df_siRNA_20.SM_other <- df_all[!(df_all$unique_featureID %in% df_siRNA_20.SM$unique_featureID) & (df_all$gene_ID %in% df_siRNA_20.SM$gene_ID),]

features_to_add <- vector()
for (gene in df_siRNA_20.SM$gene_ID) {
  if (df_siRNA_20.SM[df_siRNA_20.SM$gene_ID==gene,]$mean_diffsiSam68>0) {
      feature <- df_siRNA_20.SM_other[df_siRNA_20.SM_other$gene_ID==gene,] %>% slice_min(mean_diffsiSam68<0,n=1,with_ties=FALSE)
     features_to_add<- append(features_to_add,feature$unique_featureID)} else {
      feature <- df_siRNA_20.SM_other[df_siRNA_20.SM_other$gene_ID==gene,] %>% slice_max(mean_diffsiSam68>0,n=1,with_ties=FALSE)
     features_to_add<- append(features_to_add,feature$unique_featureID)}}

df_siRNA_20.SM_PO <- rbind(df_siRNA_20.SM,df_siRNA_20.SM_other[df_siRNA_20.SM_other$unique_featureID %in% features_to_add,])
length(unique(df_siRNA_20.SM_PO$gene_ID))
```


```{r}
Regulatable_sites <-df_all[df_all$unique_featureID %in% unique(c(df_siRNA_20.SM_PO$unique_featureID,df_siRNA_20.EL_PO$unique_featureID,df_siRNA_20.CF_PO$unique_featureID)),] 

length(unique(Regulatable_sites$gene_ID))

Regulatable_sites_noPRMT <- Regulatable_sites[!(Regulatable_sites$gene_ID %in% df_prmt_20_15_70_PO$gene_ID),]
nrow(Regulatable_sites_noPRMT)
length(unique(Regulatable_sites_noPRMT$gene_ID))


write_csv(Regulatable_sites_noPRMT,'../Outputs/Regulatable_sites.csv')
```

#Control sites

took original ds and removed all prev found genes
```{r}
Ctrl <- df_all[(!(df_all$gene_ID %in% Regulatable_sites_noPRMT$gene_ID) & !(df_all$gene_ID %in% df_prmt_20_15_70_PO$gene_ID)),]
```

Looked at density and saw mean was really high
```{r}
density(na.omit(rowMeans(Ctrl[,7:14],na.rm = TRUE)))
plot(density(na.omit(rowMeans(Ctrl[,7:14],na.rm = TRUE))))
```

so looked into it and most of those with high mean have lots of NA that filter them of from other categories
removed all NA rows in either siRNA or DI
```{r}
a <- Ctrl
a.1 <- a[(!(is.na(a$mean_diffsiCFIM25) & is.na(a$mean_diffsiELAVL1) & is.na(a$mean_diffsiSam68)) & (!(is.na(a$mean_diff96) & is.na(a$mean_diff24) & is.na(a$mean_diff48) & is.na(a$mean_diff72) & is.na(a$mean_diff96hrs_prev)))),]
```

Now perfectly centered. I'd cut 15% (1st ans 3rd quart)
```{r}
plot(density(na.omit(rowMeans(a.1[,7:14],na.rm = TRUE))))
density(na.omit(rowMeans(a.1[,7:14],na.rm = TRUE)))
```

very few genes are mean >15
```{r}
a.2 <- a.1[abs(rowMeans(a.1[,7:14],na.rm = TRUE))>0.15,]
```




```{r}
df_ctrl <- Ctrl
```


##mean

Check for less 15% each + mean of DMSO usage >5%

```{r}
cut_off_1.ctrl <- 0.15
df_15_5<- df_ctrl %>% 
  filter((mean_diff24  >-cut_off_1.ctrl& mean_diff24< cut_off_1.ctrl)&
         (mean_diff48  >-cut_off_1.ctrl& mean_diff48< cut_off_1.ctrl)&
         (mean_diff72  >-cut_off_1.ctrl& mean_diff72< cut_off_1.ctrl)&
         (mean_diff96  >-cut_off_1.ctrl& mean_diff96< cut_off_1.ctrl)&
         (mean_diff96hrs_prev  >-cut_off_1.ctrl& mean_diff96hrs_prev< cut_off_1.ctrl)&
         (mean_diffsiCFIM25  >-cut_off_1.ctrl& mean_diffsiCFIM25< cut_off_1.ctrl)&
         (mean_diffsiELAVL1  >-cut_off_1.ctrl& mean_diffsiELAVL1< cut_off_1.ctrl)&
         (mean_diffsiSam68  >-cut_off_1.ctrl& mean_diffsiSam68< cut_off_1.ctrl)) %>% 
filter(mean(na.omit(ctrl_siELAVL1,ctrl_siSam68,ctrl_siCFIM25,ctrl_96hrs_prev,ctrl_96,ctrl_72,ctrl_48,ctrl_24))>0.05)

length(unique(df_15_5$gene_ID))


```


#Keeping PO

Keeping for each gene the 2 most used sites (calc as average across all ds)

```{r}
to_keep_control <- vector()
for (gene in unique(df_15_5$gene_ID)) {
 
  #for each gene 
  #look at how many unique features
    uniqueFG <- df_15_5[df_15_5$gene_ID==gene,]$unique_featureID
    #if more than 2 features 
    if (length(uniqueFG)>=2) {
      biggest <- -100
      Sec_biggest <- -100
      f_ID_biggest <- character()
      f_ID_Sec_biggest <- character()
      for (feature in uniqueFG) {
        mean_tmp <- mean(na.omit(as.vector(t(df_15_5[df_15_5$gene_ID==gene & df_15_5$unique_featureID==feature,][c('ctrl_siELAVL1','ctrl_siSam68','ctrl_siCFIM25','ctrl_96hrs_prev','ctrl_96','ctrl_72','ctrl_48','ctrl_24')]))))#na.omit()
        #if (is.na(mean_tmp )==FALSE) {
          if (mean_tmp>biggest) {
            Sec_biggest<-biggest
            biggest <- mean_tmp 
            f_ID_Sec_biggest<-f_ID_biggest
            f_ID_biggest <- feature}
        else {
        if (mean_tmp>Sec_biggest) {
          Sec_biggest <- mean_tmp 
          f_ID_Sec_biggest <- feature}
        }
      }
      
        to_keep_control <- append(to_keep_control, c(f_ID_Sec_biggest,f_ID_biggest))
      }
      
    }
    
```


## removed all genes found in orev 2 categories

```{r}
df_control_pairs <- df_15_5[df_15_5$unique_featureID %in% to_keep_control,]

nrow(df_control_pairs)
length(unique(df_control_pairs$gene_ID))

write_csv2(df_control_final,'../Data/Outputs/Control_sites')
```




#Merge data categories to use for clustering 
```{r}
df_control_pairs$category <- 'Control_sites'
Regulatable_sites_noPRMT$category <- 'Regulatable_sites'
df_prmt_20_15_70_PO$category <- 'PRMT_regulated'

```


```{r}
df_all_categories <- rbind(df_control_pairs,Regulatable_sites_noPRMT,df_prmt_20_15_70_PO[,-87])

write_csv(df_all_categories,'../Outputs/All_categories_df.csv')
```






